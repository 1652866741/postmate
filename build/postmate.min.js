/**
 * postmate - A powerful, simple, promise-based postMessage library
 * @version v1.1.6
 * @link https://github.com/dollarshaveclub/postmate
 * @author Jacob Kelley <jakie8@gmail.com>
 * @license MIT */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Postmate=t()}(this,function(){"use strict";function e(){return++d}function t(){var e;h.debug&&(e=console).log.apply(e,arguments)}function n(e){var t=document.createElement("a");return t.href=e,t.origin||t.protocol+"//"+t.hostname}function r(e,t){return e.origin===t&&("object"===a(e.data)&&("postmate"in e.data&&(e.data.type===u&&!!{"handshake-reply":1,call:1,emit:1,reply:1,request:1}[e.data.postmate])))}function i(e,t){var n="function"==typeof e[t]?e[t]():e[t];return h.Promise.resolve(n)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=(function(){function e(e){this.value=e}function t(t){function n(e,t){return new Promise(function(n,i){var s={key:e,arg:t,resolve:n,reject:i,next:null};o?o=o.next=s:(a=o=s,r(e,t))})}function r(n,a){try{var o=t[n](a),s=o.value;s instanceof e?Promise.resolve(s.value).then(function(e){r("next",e)},function(e){r("throw",e)}):i(o.done?"return":"normal",o.value)}catch(e){i("throw",e)}}function i(e,t){switch(e){case"return":a.resolve({value:t,done:!0});break;case"throw":a.reject(t);break;default:a.resolve({value:t,done:!1})}a=a.next,a?r(a.key,a.arg):o=null}var a,o;this._invoke=n,"function"!=typeof t.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u="application/x-postmate-v1+json",d=0,l=function(){function n(e){var r=this;o(this,n),this.parent=e.parent,this.frame=e.frame,this.child=e.child,this.childOrigin=e.childOrigin,this.events={},t("Parent: Registering API"),t("Parent: Awaiting messages..."),this.listener=function(e){var n=((e||{}).data||{}).value||{},i=n.data,a=n.name;"emit"===e.data.postmate&&(t("Parent: Received event emission: "+a),a in r.events&&r.events[a].call(r,i))},this.parent.addEventListener("message",this.listener,!1),t("Parent: Awaiting event emissions from Child")}return s(n,[{key:"get",value:function(t){var n=this;return new h.Promise(function(r){var i=e(),a=function e(t){t.data.uid===i&&"reply"===t.data.postmate&&(n.parent.removeEventListener("message",e,!1),r(t.data.value))};n.parent.addEventListener("message",a,!1),n.child.postMessage({postmate:"request",type:u,property:t,uid:i},n.childOrigin)})}},{key:"call",value:function(e,t){this.child.postMessage({postmate:"call",type:u,property:e,data:t},this.childOrigin)}},{key:"on",value:function(e,t){this.events[e]=t}},{key:"destroy",value:function(){t("Parent: Destroying Postmate instance"),window.removeEventListener("message",this.listener,!1),this.frame.parentNode.removeChild(this.frame)}}]),n}(),c=function(){function e(n){var a=this;o(this,e),this.model=n.model,this.parent=n.parent,this.parentOrigin=n.parentOrigin,this.child=n.child,t("Child: Registering API"),t("Child: Awaiting messages..."),this.child.addEventListener("message",function(e){if(r(e,a.parentOrigin)){t("Child: Received request",e.data);var n=e.data,o=n.property,s=n.uid,d=n.data;return"call"===e.data.postmate?void(o in a.model&&"function"==typeof a.model[o]&&a.model[o].call(a,d)):void i(a.model,o).then(function(t){return e.source.postMessage({property:o,postmate:"reply",type:u,uid:s,value:t},e.origin)})}})}return s(e,[{key:"emit",value:function(e,n){t('Child: Emitting Event "'+e+'"',n),this.parent.postMessage({postmate:"emit",type:u,value:{name:e,data:n}},this.parentOrigin)}}]),e}(),h=function(){function e(t){o(this,e);var n=t.container,r=t.url,i=t.model;return this.parent=window,this.frame=document.createElement("iframe"),(n||document.body).appendChild(this.frame),this.child=this.frame.contentWindow||this.frame.contentDocument.parentWindow,this.model=i||{},this.sendHandshake(r)}return s(e,[{key:"sendHandshake",value:function(i){var a=this,o=n(i),s=0,d=void 0;return new e.Promise(function(e,n){var c=function i(s){return!!r(s,o)&&("handshake-reply"===s.data.postmate?(clearInterval(d),t("Parent: Received handshake reply from Child"),a.parent.removeEventListener("message",i,!1),a.childOrigin=s.origin,t("Parent: Saving Child origin",a.childOrigin),e(new l(a))):(t("Parent: Invalid handshake reply"),n("Failed handshake")))};a.parent.addEventListener("message",c,!1);var h=function(){s++,t("Parent: Sending handshake attempt "+s,{childOrigin:o}),a.child.postMessage({postmate:"handshake",type:u,model:a.model},o)},f=function(){h(),d=setInterval(h,500)};a.frame.attachEvent?a.frame.attachEvent("onload",f):a.frame.onload=f,t("Parent: Loading frame",{url:i}),a.frame.src=i})}}]),e}();return h.debug=!1,h.Promise=function(){try{return window?window.Promise:Promise}catch(e){return null}}(),h.Model=function(){function e(t){return o(this,e),this.child=window,this.model=t,this.parent=this.child.parent,this.sendHandshakeReply()}return s(e,[{key:"sendHandshakeReply",value:function(){var e=this;return new h.Promise(function(n,r){var i=function i(a){if("handshake"===a.data.postmate){t("Child: Received handshake from Parent"),e.child.removeEventListener("message",i,!1),t("Child: Sending handshake reply to Parent"),a.source.postMessage({postmate:"handshake-reply",type:u},a.origin),e.parentOrigin=a.origin;var o=a.data.model;if(o){for(var s=Object.keys(o),d=0;d<s.length;d++)o.hasOwnProperty(s[d])&&(e.model[s[d]]=o[s[d]]);t("Child: Inherited and extended model from Parent")}return t("Child: Saving Parent origin",e.parentOrigin),n(new c(e))}return r("Handshake Reply Failed")};e.child.addEventListener("message",i,!1)})}}]),e}(),h});
