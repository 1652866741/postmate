/**
 * postmate - A powerful, simple, promise-based postMessage library
 * @version v0.3.0
 * @link https://github.com/dollarshaveclub/postmate
 * @license MIT
 */
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.Postmate=n()}(this,function(){"use strict";function e(){var e;(e=console).log.apply(e,arguments)}function n(e){var n=document.createElement("a");return n.href=e,n.origin}function t(e,n){return e.origin===n&&("object"===o(e.data)&&("postmate"in e.data&&e.data.type===l))}function a(e,n){var t="function"==typeof e[n]?e[n]():e[n];return Promise.resolve(t)}function i(n){var t=this,a=n.parent,i=n.frame,r=n.child,o=n.childOrigin;e("Registering Child API"),e("Parent awaiting messages..."),this.events={},this.listening=!1,this.frame=i,this.get=function(e){return new Promise(function(n){var t=(new Date).getTime(),i=function e(i){i.data.uid===t&&"reply"===i.data.postmate&&(a.removeEventListener("message",e,!1),n(i.data.value))};a.addEventListener("message",i,!1),r.postMessage({postmate:"request",type:l,property:e,uid:t},o)})},this.on=function(n,i){var r=function(n){var a=((n||{}).data||{}).value||{},i=a.data,r=a.name;"emit"===n.data.postmate&&(e("Parent: Received event emission: "+r),r in t.events&&t.events[r].call(t,i))};t.listening||(e("Parent: Awaiting event emissions from Child"),a.addEventListener("message",r,!1),t.listening=!0),t.events[n]=i}}function r(n){var i=n.model,r=n.parent,o=n.parentOrigin,s=n.child;e("Registering Parent API"),e("Child awaiting messages..."),s.addEventListener("message",function(n){if(t(n,o)){e("Child received message",n.data);var r=n.data,s=r.property,d=r.uid;a(i,s).then(function(e){return n.source.postMessage({property:s,postmate:"reply",type:l,uid:d,value:e},n.origin)})}}),this.model=i,this.emit=function(e,n){console.log("EMITTING EVENT",e,n),r.postMessage({postmate:"emit",type:l,value:{name:e,data:n}},o)}}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},s=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},d=function(){function e(e,n){for(var t=0;t<n.length;t++){var a=n[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(n,t,a){return t&&e(n.prototype,t),a&&e(n,a),n}}(),l="application/x-postmate-v1+json",u=function(){function a(e){s(this,a);var n=e.container,t=e.url,i=e.model;return this.parent=window,this.frame=document.createElement("iframe"),(n||document.body).appendChild(this.frame),this.child=this.frame.contentWindow,this.model=i||{},this.sendHandshake(t)}return d(a,[{key:"sendHandshake",value:function(a){var r=this,o=n(a);return new Promise(function(n,s){var d=function a(d){return!!t(d,o)&&("handshake-reply"===d.data.postmate?(e("Parent: Received handshake reply from Child"),r.parent.removeEventListener("message",a,!1),r.childOrigin=d.origin,e("Parent: Saving Child origin",r.childOrigin),n(new i(r))):(e("Parent: Invalid handshake reply"),s("Failed handshake")))};r.parent.addEventListener("message",d,!1),r.frame.onload=function(){e("Parent: Sending handshake"),r.child.postMessage({postmate:"handshake",type:l,model:r.model},o)},e("Parent: Loading frame"),r.frame.src=a})}}]),a}();return u.Model=function(){function n(e){return s(this,n),this.child=window,this.model=e,this.parent=this.child.parent,this.sendHandshakeReply()}return d(n,[{key:"sendHandshakeReply",value:function(){var n=this;return new Promise(function(t,a){var i=function i(o){if("handshake"===o.data.postmate){e("Child: Received handshake from Parent"),n.child.removeEventListener("message",i,!1),e("Child: Sending handshake reply to Parent"),o.source.postMessage({postmate:"handshake-reply",type:l},o.origin),n.parentOrigin=o.origin;var s=o.data.model;if(s){for(var d=Object.keys(s),u=0;u<d.length;u++)s.hasOwnProperty(d[u])&&(n.model[d[u]]=s[d[u]]);e("Child: Inherited and extended model from Parent")}return e("Child: Saving Parent origin",n.parentOrigin),t(new r(n))}return a("Handshake Reply Failed")};n.child.addEventListener("message",i,!1)})}}]),n}(),u});